<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.2, maximum-scale=2.0, viewport-fit=cover" />
    <title>Lékovka S24 Edition</title>
    <link rel="apple-touch-icon" href="https://api.iconify.design/lucide:pill.png?color=%238b8071&width=180">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f0ede9; --shadow-light: #ffffff; --shadow-dark: #d1ccc3; --primary: #434343; --accent: #8b8071; --text: #4a4541; }
        .dark { --bg: #2d2a27; --shadow-light: #3a3632; --shadow-dark: #201e1b; --primary: #e8ece8; --accent: #b0a496; --text: #d6d2cd; }
        body { background-color: var(--bg); font-family: 'Quicksand', sans-serif; color: var(--text); min-height: 100vh; transition: 0.3s; -webkit-tap-highlight-color: transparent; font-size: 18px; }
        .neu-raised { background: var(--bg); box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light); border-radius: 20px; }
        .neu-inset { background: var(--bg); box-shadow: inset 6px 6px 12px var(--shadow-dark), inset -6px -6px 12px var(--shadow-light); border-radius: 14px; }
        .neu-btn { background: var(--bg); box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light); cursor: pointer; border: none; border-radius: 14px; display: flex; align-items: center; justify-content: center; color: var(--text); min-height: 52px; font-size: 17px; font-weight: 700; }
        .neu-btn:active { box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light); transform: scale(0.97); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-day { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-weight: 700; font-size: 16px; min-height: 42px; }
        .cal-header { font-size: 11px; font-weight: 900; opacity: 0.4; text-align: center; text-transform: uppercase; padding-bottom: 5px; }
        input { border: none; outline: none; background: transparent; width: 100%; font-weight: 700; padding: 10px; color: var(--primary); font-size: 19px !important; }
        .hidden { display: none !important; }
        .taken-row { opacity: 0.3; text-decoration: line-through; }
    </style>
</head>
<body class="p-4">

<div class="max-w-md mx-auto">
    <div class="flex justify-between items-center mb-8 gap-3">
        <button onclick="toggleDarkMode()" class="neu-btn w-14 h-14 shrink-0"><span class="iconify" id="dark-icon" data-icon="lucide:moon" data-width="26"></span></button>
        <button onclick="switchTab('today')" id="tab-today" class="neu-btn flex-1 active">DNES</button>
        <button onclick="switchTab('calendar')" id="tab-calendar" class="neu-btn flex-1">HISTORIE</button>
        <button onclick="requestNotif()" class="neu-btn w-14 h-14 shrink-0 text-blue-500"><span class="iconify" data-icon="lucide:bell" data-width="26"></span></button>
    </div>

    <div id="view-today">
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="neu-raised p-5 text-center"><label class="text-[11px] font-black opacity-50 block uppercase">Zbývá</label><span id="stat-rem" class="text-3xl font-black text-accent">0</span></div>
            <div class="neu-raised p-5 text-center"><label class="text-[11px] font-black opacity-50 block uppercase">Čas</label><span id="live-clock" class="text-3xl font-black text-slate-500">00:00</span></div>
        </div>

        <div id="plan-list" class="space-y-6 mb-10"></div>

        <div id="form-container" class="neu-raised p-6">
            <h2 class="font-black mb-6 text-center text-accent uppercase text-sm tracking-widest">Přidat nový lék</h2>
            <div class="space-y-5">
                <div class="neu-inset p-1"><input id="f-nazev" type="text" placeholder="Název léku"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="neu-inset p-1"><input id="f-zasoba" type="number" placeholder="Sklad ks"></div>
                    <div class="neu-inset p-1"><input id="f-davka" type="number" value="1"></div>
                </div>
                <div class="neu-inset p-1"><input id="f-custom-time" type="time"></div>
                <button onclick="saveMedicine()" class="neu-btn bg-slate-700 text-white w-full py-4 font-black uppercase">Uložit lék</button>
            </div>
        </div>
    </div>

    <div id="view-calendar" class="hidden">
        <div class="neu-raised p-5">
            <div class="flex justify-between items-center mb-6">
                <button onclick="changeMonth(-1)" class="neu-btn px-4"><</button>
                <h2 id="month-label" class="font-black text-lg uppercase tracking-tight">Únor 2026</h2>
                <button onclick="changeMonth(1)" class="neu-btn px-4">></button>
            </div>
            <div class="calendar-grid">
                <div class="cal-header">Po</div><div class="cal-header">Út</div><div class="cal-header">St</div><div class="cal-header">Čt</div><div class="cal-header">Pá</div><div class="cal-header">So</div><div class="cal-header">Ne</div>
            </div>
            <div id="calendar-body" class="calendar-grid"></div>
            
            <div id="day-detail" class="neu-inset p-5 mt-8 hidden">
                <h3 id="detail-date" class="font-bold text-sm mb-4 opacity-50 border-b pb-2"></h3>
                <div id="detail-list" class="space-y-3"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const DB_KEY = "Lekovka_V2026_Final";
    const HIST_KEY = "Lekovka_Hist_V2026_Final";
    let viewDate = new Date();

    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    const load = (k) => JSON.parse(localStorage.getItem(k)) || [];
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    function switchTab(t) {
        document.getElementById('view-today').classList.toggle('hidden', t !== 'today');
        document.getElementById('view-calendar').classList.toggle('hidden', t !== 'calendar');
        if(t === 'calendar') renderCalendar();
    }

    function toggleDarkMode() {
        const dark = document.body.classList.toggle('dark');
        localStorage.setItem('dark-mode', dark);
    }

    function saveMedicine() {
        const name = document.getElementById('f-nazev').value;
        const time = document.getElementById('f-custom-time').value;
        if(!name || !time) return alert("Chybí jméno nebo čas");
        let meds = load(DB_KEY);
        meds.push({ id: Date.now(), name, stock: parseFloat(document.getElementById('f-zasoba').value)||0, dose: parseFloat(document.getElementById('f-davka').value)||1, times: [time], icon: 'lucide:pill' });
        save(DB_KEY, meds); render();
    }

    function render() {
        const meds = load(DB_KEY); const hist = load(HIST_KEY);
        const todayStr = new Date().toLocaleDateString('cs-CZ');
        const list = document.getElementById('plan-list'); list.innerHTML = "";
        let rem = 0;

        meds.forEach(m => {
            let timesHtml = "";
            m.times.forEach(t => {
                const done = hist.some(h => h.medId === m.id && h.date === todayStr && h.time === t);
                if(!done) rem++;
                timesHtml += `<div class="flex justify-between items-center py-3 border-b border-black/5 last:border-0 ${done?'taken-row':''}">
                    <span class="font-black text-lg">${t}</span>
                    ${done ? '✅' : `<button onclick="take(${m.id},'${t}')" class="neu-btn px-6 text-xs">VZÍT</button>`}
                </div>`;
            });
            list.innerHTML += `<div class="neu-raised p-6">
                <div class="flex justify-between items-start mb-4">
                    <div><h3 class="font-black text-xl">${m.name}</h3><p class="text-[11px] font-bold opacity-40 uppercase">Sklad: ${m.stock} ks</p></div>
                    <button onclick="deleteMed(${m.id})" class="text-red-300">✕</button>
                </div>
                <div class="neu-inset p-3">${timesHtml}</div>
            </div>`;
        });
        document.getElementById('stat-rem').innerText = rem;
    }

    window.take = (id, t) => {
        let meds = load(DB_KEY); let m = meds.find(x => x.id === id);
        m.stock = Math.round((m.stock - m.dose)*100)/100;
        let hist = load(HIST_KEY); hist.push({ medId: id, time: t, date: new Date().toLocaleDateString('cs-CZ') });
        save(DB_KEY, meds); save(HIST_KEY, hist); render();
    };

    window.deleteMed = (id) => confirm("Smazat?") && (save(DB_KEY, load(DB_KEY).filter(x => x.id != id)), render());

    function renderCalendar() {
        const body = document.getElementById('calendar-body'); body.innerHTML = "";
        const hist = load(HIST_KEY);
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        document.getElementById('month-label').innerText = new Intl.DateTimeFormat('cs-CZ', {month:'long', year:'numeric'}).format(viewDate);
        
        const firstDay = (new Date(y, m, 1).getDay() + 6) % 7;
        const daysInMonth = new Date(y, m + 1, 0).getDate();

        for(let i=0; i < firstDay; i++) body.innerHTML += `<div></div>`;
        for(let d=1; d <= daysInMonth; d++) {
            const dStr = new Date(y, m, d).toLocaleDateString('cs-CZ');
            const taken = hist.filter(h => h.date === dStr).length;
            body.innerHTML += `<div onclick="showDetail('${dStr}')" class="cal-day neu-btn ${taken>0?'text-green-600 border border-green-200':''}">${d}</div>`;
        }
    }

    function showDetail(dStr) {
        const det = document.getElementById('day-detail'); det.classList.remove('hidden');
        document.getElementById('detail-date').innerText = dStr;
        const hist = load(HIST_KEY).filter(h => h.date === dStr);
        const meds = load(DB_KEY);
        const list = document.getElementById('detail-list'); list.innerHTML = hist.length ? "" : "Žádné záznamy";
        hist.forEach(h => {
            const m = meds.find(x => x.id === h.medId);
            list.innerHTML += `<div class="flex justify-between text-sm font-bold"><span>${h.time}</span><span>${m?m.name:'Smazaný lék'}</span></div>`;
        });
    }

    function changeMonth(d) { viewDate.setMonth(viewDate.getMonth() + d); renderCalendar(); }
    function requestNotif() { Notification.requestPermission(); }
    setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('cs-CZ', {hour:'2-digit', minute:'2-digit'}); }, 1000);
    render();
</script>
</body>
</html>
