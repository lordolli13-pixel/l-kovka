<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Lékovka Ultimate S24</title>
    <link rel="apple-touch-icon" href="https://api.iconify.design/lucide:pill.png?color=%238b8071&width=180">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f0ede9; --shadow-light: #ffffff; --shadow-dark: #d1ccc3; --primary: #434343; --accent: #8b8071; --text: #4a4541; }
        .dark { --bg: #2d2a27; --shadow-light: #3a3632; --shadow-dark: #201e1b; --primary: #e8ece8; --accent: #b0a496; --text: #d6d2cd; }
        body { background-color: var(--bg); font-family: 'Quicksand', sans-serif; color: var(--text); min-height: 100vh; transition: 0.3s; font-size: 17px; }
        
        .neu-raised { background: var(--bg); box-shadow: 7px 7px 14px var(--shadow-dark), -7px -7px 14px var(--shadow-light); border-radius: 20px; }
        .neu-inset { background: var(--bg); box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light); border-radius: 12px; }
        .neu-btn { background: var(--bg); box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; min-height: 50px; font-weight: 700; transition: 0.2s; }
        .neu-btn:active { box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light); transform: scale(0.97); }
        
        /* Kalendář - responzivní úprava pro S24 */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-day { aspect-ratio: 1/1; font-size: 14px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; position: relative; }
        .cal-dot { width: 5px; height: 5px; background: #10b981; border-radius: 50%; position: absolute; bottom: 4px; }
        
        .day-checkbox:checked + label, .time-checkbox:checked + label, .mode-radio:checked + label, .icon-radio:checked + label { 
            box-shadow: inset 3px 3px 6px var(--shadow-dark); color: var(--accent); font-weight: 800; border: 1px solid var(--accent); 
        }
        input { border: none; outline: none; background: transparent; width: 100%; font-weight: 700; padding: 8px; color: var(--primary); font-size: 18px !important; }
        .hidden { display: none !important; }
        .taken-row { opacity: 0.3; text-decoration: line-through; }
    </style>
</head>
<body class="p-3">

<div class="max-w-md mx-auto">
    <div class="flex justify-between items-center mb-6 gap-2">
        <button onclick="toggleDarkMode()" class="neu-btn w-12 h-12 shrink-0"><span class="iconify" id="dark-icon" data-icon="lucide:moon"></span></button>
        <div class="flex gap-2 flex-1">
            <button onclick="switchTab('today')" id="tab-today" class="neu-btn flex-1 text-sm active">DNES</button>
            <button onclick="switchTab('calendar')" id="tab-calendar" class="neu-btn flex-1 text-sm">HISTORIE</button>
        </div>
        <button onclick="requestNotif()" class="neu-btn w-12 h-12 shrink-0 text-blue-500"><span class="iconify" data-icon="lucide:bell"></span></button>
    </div>

    <div id="view-today">
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="neu-raised p-4 text-center"><label class="text-[10px] font-bold opacity-50 block uppercase">Zbývá</label><span id="stat-rem" class="text-2xl font-black text-accent">0</span></div>
            <div class="neu-raised p-4 text-center"><label class="text-[10px] font-bold opacity-50 block uppercase">Čas</label><span id="live-clock" class="text-2xl font-black opacity-50">00:00</span></div>
        </div>

        <div id="plan-list" class="space-y-4 mb-8"></div>

        <div id="form-container" class="neu-raised p-5">
            <h2 class="font-black mb-4 text-center text-accent uppercase text-xs tracking-widest">Nastavení léku</h2>
            
            <div class="space-y-4">
                <div class="neu-inset px-2"><input id="f-nazev" type="text" placeholder="Název léku"></div>
                
                <div class="flex justify-around p-2 neu-inset">
                    <input type="radio" name="f-icon" id="i1" value="lucide:pill" checked class="icon-radio hidden"><label for="i1" class="neu-btn w-10 h-10"><span class="iconify" data-icon="lucide:pill"></span></label>
                    <input type="radio" name="f-icon" id="i2" value="lucide:droplets" class="icon-radio hidden"><label for="i2" class="neu-btn w-10 h-10"><span class="iconify" data-icon="lucide:droplets"></span></label>
                    <input type="radio" name="f-icon" id="i3" value="lucide:syringe" class="icon-radio hidden"><label for="i3" class="neu-btn w-10 h-10"><span class="iconify" data-icon="lucide:syringe"></span></label>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="neu-inset px-2"><label class="text-[9px] block opacity-50 ml-1">Sklad</label><input id="f-zasoba" type="number" step="0.5" value="10"></div>
                    <div class="neu-inset px-2"><label class="text-[9px] block opacity-50 ml-1">Dávka</label><input id="f-davka" type="number" step="0.5" value="1"></div>
                </div>

                <div>
                    <label class="text-[10px] font-bold uppercase opacity-50 mb-2 block">Kdy užívat?</label>
                    <div class="flex gap-2 mb-3">
                        <input type="radio" id="m-days" name="mode" value="days" class="mode-radio hidden" checked onchange="toggleMode()"><label for="m-days" class="neu-btn flex-1 text-[10px]">DNY</label>
                        <input type="radio" id="m-ob" name="mode" value="everyother" class="mode-radio hidden" onchange="toggleMode()"><label for="m-ob" class="neu-btn flex-1 text-[10px]">OB DEN</label>
                    </div>
                    <div id="box-days" class="flex justify-between gap-1">
                        </div>
                </div>

                <div class="neu-inset px-2"><label class="text-[9px] block opacity-50 ml-1">Čas</label><input id="f-time" type="time"></div>

                <input type="hidden" id="f-id">
                <button onclick="saveMedicine()" class="neu-btn bg-slate-700 text-white w-full uppercase py-4">Uložit</button>
            </div>
        </div>
    </div>

    <div id="view-calendar" class="hidden">
        <div class="neu-raised p-4">
            <div class="flex justify-between items-center mb-4">
                <button onclick="changeMonth(-1)" class="neu-btn w-10 h-10"><</button>
                <h2 id="month-label" class="font-black uppercase text-sm">Březen 2026</h2>
                <button onclick="changeMonth(1)" class="neu-btn w-10 h-10">></button>
            </div>
            <div class="calendar-grid text-[10px] font-bold opacity-30 text-center mb-2">
                <div>Po</div><div>Út</div><div>St</div><div>Čt</div><div>Pá</div><div>So</div><div>Ne</div>
            </div>
            <div id="calendar-body" class="calendar-grid"></div>
            
            <div id="day-detail" class="neu-inset p-4 mt-6 hidden">
                <h3 id="detail-date" class="font-bold text-xs mb-3 opacity-50 uppercase"></h3>
                <div id="detail-list" class="space-y-2 text-sm"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const DB_KEY = "Lekovka_V2026_Final";
    const HIST_KEY = "Lekovka_Hist_V2026_Final";
    let viewDate = new Date();

    // Init dny
    const daysName = ["Ne","Po","Út","St","Čt","Pá","So"];
    const dBox = document.getElementById('box-days');
    [1,2,3,4,5,6,0].forEach(d => {
        dBox.innerHTML += `<input type="checkbox" id="d-${d}" value="${d}" class="day-checkbox hidden"><label for="d-${d}" class="w-10 h-10 neu-btn text-[10px]">${daysName[d]}</label>`;
    });

    const load = (k) => JSON.parse(localStorage.getItem(k)) || [];
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    function switchTab(t) {
        document.getElementById('view-today').classList.toggle('hidden', t !== 'today');
        document.getElementById('view-calendar').classList.toggle('hidden', t !== 'calendar');
        if(t === 'calendar') renderCalendar();
    }

    function toggleMode() {
        document.getElementById('box-days').classList.toggle('hidden', document.getElementById('m-ob').checked);
    }

    function toggleDarkMode() {
        document.body.classList.toggle('dark');
        localStorage.setItem('dark-mode', document.body.classList.contains('dark'));
    }

    function shouldShowToday(m, date) {
        const d = new Date(date); d.setHours(0,0,0,0);
        if (m.mode === 'everyother') {
            const start = new Date(m.startDate || 0); start.setHours(0,0,0,0);
            return Math.round((d - start) / 86400000) % 2 === 0;
        }
        return m.days.length === 0 || m.days.includes(d.getDay());
    }

    function saveMedicine() {
        const name = document.getElementById('f-nazev').value;
        const time = document.getElementById('f-time').value;
        const id = document.getElementById('f-id').value;
        if(!name || !time) return alert("Jméno a čas!");

        let meds = load(DB_KEY);
        const medObj = {
            id: id ? parseInt(id) : Date.now(),
            name, time,
            icon: document.querySelector('input[name="f-icon"]:checked').value,
            stock: parseFloat(document.getElementById('f-zasoba').value) || 0,
            dose: parseFloat(document.getElementById('f-davka').value) || 1,
            mode: document.querySelector('input[name="mode"]:checked').value,
            days: Array.from(document.querySelectorAll(".day-checkbox:checked")).map(c => parseInt(c.value)),
            startDate: id ? meds.find(x=>x.id==id).startDate : new Date().toISOString()
        };

        if(id) meds = meds.map(m => m.id == id ? medObj : m); else meds.push(medObj);
        save(DB_KEY, meds);
        resetForm();
        render();
    }

    function render() {
        const meds = load(DB_KEY); const hist = load(HIST_KEY);
        const todayStr = new Date().toLocaleDateString('cs-CZ');
        const list = document.getElementById('plan-list'); list.innerHTML = "";
        let rem = 0;

        meds.forEach(m => {
            if(!shouldShowToday(m, new Date())) return;
            const done = hist.some(h => h.medId === m.id && h.date === todayStr);
            if(!done) rem++;

            list.innerHTML += `<div class="neu-raised p-4 flex items-center gap-4 ${done?'taken-row':''}">
                <div class="neu-inset p-3"><span class="iconify" data-icon="${m.icon}"></span></div>
                <div class="flex-1">
                    <h3 class="font-bold">${m.name}</h3>
                    <p class="text-[11px] font-bold opacity-40">${m.time} | Dávka: ${m.dose}ks | Sklad: ${m.stock}</p>
                </div>
                ${done ? '✅' : `<button onclick="take(${m.id})" class="neu-btn px-4 text-xs">VZÍT</button>`}
                <button onclick="editMed(${m.id})" class="opacity-20 text-xs">edit</button>
            </div>`;
        });
        document.getElementById('stat-rem').innerText = rem;
    }

    window.take = (id) => {
        let meds = load(DB_KEY); let m = meds.find(x => x.id === id);
        m.stock = Math.round((m.stock - m.dose) * 100) / 100;
        let hist = load(HIST_KEY);
        hist.push({ medId: id, date: new Date().toLocaleDateString('cs-CZ'), time: new Date().toLocaleTimeString() });
        save(DB_KEY, meds); save(HIST_KEY, hist); render();
    };

    window.editMed = (id) => {
        const m = load(DB_KEY).find(x => x.id === id);
        document.getElementById('f-id').value = m.id;
        document.getElementById('f-nazev').value = m.name;
        document.getElementById('f-time').value = m.time;
        document.getElementById('f-zasoba').value = m.stock;
        document.getElementById('f-davka').value = m.dose;
        document.getElementById('m-days').checked = m.mode === 'days';
        document.getElementById('m-ob').checked = m.mode === 'everyother';
        document.querySelectorAll(".day-checkbox").forEach(c => c.checked = m.days.includes(parseInt(c.value)));
        toggleMode();
        window.scrollTo(0, 0);
    };

    function resetForm() {
        document.getElementById('f-id').value = ""; document.getElementById('f-nazev').value = "";
        document.getElementById('f-time').value = "";
    }

    function renderCalendar() {
        const body = document.getElementById('calendar-body'); body.innerHTML = "";
        const hist = load(HIST_KEY);
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        document.getElementById('month-label').innerText = new Intl.DateTimeFormat('cs-CZ', {month:'long', year:'numeric'}).format(viewDate);
        
        const first = (new Date(y, m, 1).getDay() + 6) % 7;
        for(let i=0; i < first; i++) body.innerHTML += `<div></div>`;
        
        for(let d=1; d <= new Date(y, m+1, 0).getDate(); d++) {
            const dStr = new Date(y, m, d).toLocaleDateString('cs-CZ');
            const hasData = hist.some(h => h.date === dStr);
            body.innerHTML += `<div onclick="showDetail('${dStr}')" class="cal-day neu-btn ${hasData?'border-green-500 border':''}">
                ${d}${hasData?'<div class="cal-dot"></div>':''}
            </div>`;
        }
    }

    function showDetail(dStr) {
        const det = document.getElementById('day-detail'); det.classList.remove('hidden');
        document.getElementById('detail-date').innerText = dStr;
        const meds = load(DB_KEY);
        const hList = load(HIST_KEY).filter(h => h.date === dStr);
        const list = document.getElementById('detail-list');
        list.innerHTML = hList.length ? "" : "Žádný záznam";
        hList.forEach(h => {
            const m = meds.find(x => x.id === h.medId);
            list.innerHTML += `<div class="flex justify-between border-b border-black/5 py-1"><span>${m?m.name:'Smazáno'}</span><span class="opacity-40">${h.time}</span></div>`;
        });
    }

    function changeMonth(n) { viewDate.setMonth(viewDate.getMonth() + n); renderCalendar(); }
    function requestNotif() { Notification.requestPermission(); }
    setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('cs-CZ', {hour:'2-digit', minute:'2-digit'}); }, 1000);
    
    if(localStorage.getItem('dark-mode') === 'true') document.body.classList.add('dark');
    render();
</script>
</body>
</html>
