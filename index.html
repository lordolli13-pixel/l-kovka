<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>L√©kovka PRO 2026</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3028/3028549.png">

    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #0f172a; 
            --card-bg: #1e293b;
            --border: #334155;
            --accent: #f59e0b; 
            --text-main: #f8fafc; 
            --red: #ef4444; 
            --green: #22c55e; 
        }
        body { background-color: var(--bg); font-family: 'Quicksand', sans-serif; color: var(--text-main); min-height: 100vh; padding: 16px; font-size: 16px; }
        .flat-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; }
        .flat-input { background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: 10px; }
        .flat-btn { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--text-main); transition: 0.2s; min-height: 48px; }
        .flat-btn:active { transform: scale(0.96); background: var(--border); }
        .btn-active { border-color: var(--accent); color: var(--accent); background: rgba(245, 158, 11, 0.1); }
        .btn-orange { background-color: var(--accent) !important; color: #0f172a !important; font-weight: 800; border: none; }
        .hidden { display: none !important; }
        .chip { padding: 12px; border-radius: 10px; font-size: 13px; font-weight: 800; cursor: pointer; background: rgba(255,255,255,0.05); text-align: center; color: white; border: 1px solid var(--border); }
        .chip-active { border-color: var(--accent); color: var(--accent); background: rgba(245, 158, 11, 0.1); }
        .progress-container { width: 100%; height: 8px; background: rgba(0,0,0,0.2); border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.3s ease; }
    </style>
</head>
<body>

<div class="max-w-2xl mx-auto pb-10">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-accent font-black tracking-tighter text-3xl uppercase">L√©kovka PRO</h1>
        <div id="date-now" class="text-[12px] font-bold opacity-50 uppercase text-right"></div>
    </div>

    <div class="flex gap-2 mb-4">
        <button onclick="switchTab('today')" id="tab-today" class="flat-btn flex-1 font-bold btn-active text-[12px] uppercase">Dnes</button>
        <button onclick="switchTab('list')" id="tab-list" class="flat-btn flex-1 font-bold text-[12px] uppercase">Z√°soby</button>
        <button onclick="switchTab('stats')" id="tab-stats" class="flat-btn flex-1 font-bold text-[12px] uppercase">Historie</button>
    </div>

    <div id="notif-bar" class="flex gap-2 mb-8 px-1">
        <button id="btn-notif-req" onclick="requestNotificationPermission()" class="flat-btn flex-1 py-2 text-[11px] font-black uppercase hidden">üîî Zapnout notifikace</button>
        <button id="btn-notif-test" onclick="sendTestNotification()" class="flat-btn flex-1 py-2 text-[11px] font-black uppercase hidden">‚ö° Test notifikace</button>
    </div>

    <div id="view-today">
        <div id="global-critical-banner" class="hidden flat-card border-red-500 bg-red-500/10 p-4 mb-4 flex items-center gap-3 text-red-500 animate-pulse">
            <span class="iconify text-2xl" data-icon="lucide:alert-octagon"></span>
            <div class="text-[13px] font-black uppercase">Pozor: Doch√°zej√≠ z√°soby l√©k≈Ø!</div>
        </div>
        
        <div class="mb-6">
            <h3 class="text-[11px] font-black uppercase opacity-40 tracking-widest mb-3 px-2">Rychl√© oznaƒçen√≠</h3>
            <div id="time-shortcuts" class="flex flex-wrap gap-2 px-1"></div>
        </div>

        <div class="flex justify-between items-center mb-4 px-2">
            <h3 class="text-[11px] font-black uppercase opacity-40 tracking-widest">Dne≈°n√≠ p≈ôehled</h3>
            <button id="btn-check-all" onclick="checkAllToday()" class="flat-btn px-4 py-2 text-[11px] font-black uppercase text-green-500 border-green-500/50 hidden">‚úì V≈°e hotovo</button>
        </div>
        <div id="daily-list" class="flex flex-col gap-3"></div>
    </div>

    <div id="view-list" class="hidden space-y-6">
        <div class="flat-card p-6">
            <h2 id="form-title" class="text-accent font-black text-sm uppercase mb-6 text-center tracking-widest">P≈ôidat nov√Ω l√©k</h2>
            <input type="hidden" id="edit-id">
            <div class="space-y-4">
                <div class="grid grid-cols-4 gap-2">
                    <div class="chip type-chip chip-active" onclick="setType(this, 'pill')" data-type="pill"><span class="iconify text-2xl mb-1 mx-auto" data-icon="lucide:pill"></span>Tbl.</div>
                    <div class="chip type-chip" onclick="setType(this, 'droplet')" data-type="droplet"><span class="iconify text-2xl mb-1 mx-auto" data-icon="lucide:droplets"></span>Kapky</div>
                    <div class="chip type-chip" onclick="setType(this, 'syrup')" data-type="syrup"><span class="iconify text-2xl mb-1 mx-auto" data-icon="lucide:test-tube"></span>Sirup</div>
                    <div class="chip type-chip" onclick="setType(this, 'syringe')" data-type="syringe"><span class="iconify text-2xl mb-1 mx-auto" data-icon="lucide:syringe"></span>Inj.</div>
                </div>
                <div class="flat-input p-3"><input id="f-name" class="w-full bg-transparent font-bold text-white outline-none text-lg" type="text" placeholder="N√°zev l√©ku..."></div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flat-input p-3"><label class="text-[10px] opacity-40 uppercase block mb-1">Celkem v balen√≠</label><input id="f-stock" class="w-full bg-transparent font-bold text-white outline-none text-lg" type="number" step="0.25" placeholder="0"></div>
                    <div class="flat-input p-3"><label class="text-[10px] opacity-40 uppercase block mb-1">U≈æ√≠van√° d√°vka</label><input id="f-dose" class="w-full bg-transparent font-bold text-white outline-none text-lg" type="number" value="1" step="0.25"></div>
                </div>
                <div id="stock-add-section" class="hidden flat-input p-3 border-accent/40 bg-accent/5">
                    <label class="text-[10px] font-black uppercase block mb-1 text-accent">Doplnit z√°sobu</label>
                    <div class="flex gap-2">
                        <input id="f-add-val" class="w-full bg-transparent font-bold text-white outline-none text-lg" type="number" placeholder="Kolik?">
                        <button onclick="addStockAction()" class="flat-btn px-4 py-1 text-[12px] font-black uppercase bg-accent text-slate-900 border-none">P≈òIƒå√çST</button>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flat-input p-3"><label class="text-[10px] opacity-40 uppercase block mb-1">ƒåasy u≈æ√≠v√°n√≠</label><input id="f-times" class="w-full bg-transparent font-bold text-white outline-none text-base" type="text" readonly placeholder="Zvolte ƒçasy..."></div>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="addTime('08:00')" class="flat-btn py-2 text-[11px] font-black uppercase">R√°no (8h)</button>
                        <button onclick="addTime('12:00')" class="flat-btn py-2 text-[11px] font-black uppercase">Obƒõd (12h)</button>
                        <button onclick="addTime('20:00')" class="flat-btn py-2 text-[11px] font-black uppercase">Veƒçer (20h)</button>
                    </div>
                    <div class="flex gap-2">
                        <input id="manual-time" type="time" class="flat-input bg-transparent text-white font-bold outline-none flex-1 px-3 py-2 text-lg">
                        <button onclick="addManualTime()" class="flat-btn px-4 py-2 text-[12px] font-black uppercase">+ ƒåAS</button>
                        <button onclick="document.getElementById('f-times').value=''" class="flat-btn px-3 text-red-500 text-[12px]">Smazat</button>
                    </div>
                </div>
                <button onclick="saveMed()" class="flat-btn btn-orange w-full py-5 text-base font-black uppercase tracking-widest mt-4">Ulo≈æit l√©k</button>
                <button onclick="cancelEdit()" id="cancel-btn" class="hidden w-full text-[12px] opacity-50 uppercase py-2">Zru≈°it</button>
            </div>
        </div>
        <div id="inventory-list" class="space-y-4 mt-8"></div>
    </div>

    <div id="view-stats" class="hidden">
        <div class="flat-card p-6">
            <div class="flex justify-between items-center mb-6">
                <button onclick="moveMonth(-1)" class="flat-btn p-3"><span class="iconify text-xl" data-icon="lucide:chevron-left"></span></button>
                <h2 id="calendar-month-year" class="text-accent font-black text-sm uppercase tracking-widest"></h2>
                <button onclick="moveMonth(1)" class="flat-btn p-3"><span class="iconify text-xl" data-icon="lucide:chevron-right"></span></button>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-2 mb-6 text-center"></div>
            <div id="detail-list" class="flat-input p-4 space-y-2 text-[14px] min-h-[120px]">
                <div class="text-center opacity-30 uppercase font-bold mt-4">Vyberte den</div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- SERVICE WORKER REGISTRACE ---
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(reg => {
            console.log("Service Worker: OK");
        }).catch(err => console.log("Service Worker: Chyba", err));
    }

    let meds = JSON.parse(localStorage.getItem('meds_v26_final')) || [];
    let history = JSON.parse(localStorage.getItem('hist_v26_final')) || [];
    let currentType = 'pill';
    let obdenType = null;
    let viewDate = new Date();
    let lastNotifKey = ""; 

    function update() { 
        localStorage.setItem('meds_v26_final', JSON.stringify(meds)); 
        localStorage.setItem('hist_v26_final', JSON.stringify(history)); 
        render(); 
    }

    function requestNotificationPermission() {
        if (!("Notification" in window)) return;
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                checkNotificationUI();
                sendTestNotification();
            }
        });
    }

    function triggerSystemNotif(title, body) {
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({ type: 'SHOW_NOTIF', title, body });
        } else {
            new Notification(title, { body });
        }
    }

    function sendTestNotification() {
        if (Notification.permission === "granted") triggerSystemNotif("L√©kovka PRO", "Test notifikac√≠ OK! üíä");
    }

    function checkNotificationUI() {
        const btnReq = document.getElementById('btn-notif-req');
        const btnTest = document.getElementById('btn-notif-test');
        if (!("Notification" in window)) return;
        if (Notification.permission === "granted") {
            btnReq.classList.add('hidden'); btnTest.classList.remove('hidden');
        } else {
            btnReq.classList.remove('hidden'); btnTest.classList.add('hidden');
        }
    }

    // --- KL√çƒåOV√Å FUNKCE PRO NOTIFIKACE ---
    function checkAndNotify() {
        if (Notification.permission !== "granted") return;
        const now = new Date();
        const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        const todayStr = now.toLocaleDateString('cs-CZ');

        meds.forEach(m => {
            if (isMedScheduledForDate(m, now)) {
                m.times.forEach(t => {
                    if (t === currentTime) {
                        const notifKey = `${m.id}_${todayStr}_${t}`;
                        const alreadyTaken = history.some(h => h.medId === m.id && h.date === todayStr && h.time === t);
                        
                        if (!alreadyTaken && lastNotifKey !== notifKey) {
                            triggerSystemNotif(`ƒåas na l√©k: ${m.name}`, `D√°vka: ${m.dose} ks.`);
                            lastNotifKey = notifKey;
                        }
                    }
                });
            }
        });
    }

    function addTime(t) { 
        let display = document.getElementById('f-times'); 
        let current = display.value ? display.value.split(',').map(x => x.trim()).filter(x => x !== "") : []; 
        if (!current.includes(t)) { current.push(t); current.sort(); display.value = current.join(', '); } 
    }

    function addManualTime() { 
        const t = document.getElementById('manual-time').value; 
        if (t) { addTime(t); document.getElementById('manual-time').value = ''; }
    }

    function setType(el, type) { 
        document.querySelectorAll('.type-chip').forEach(c => c.classList.remove('chip-active')); 
        el.classList.add('chip-active'); currentType = type; 
    }

    function addStockAction() { 
        const val = parseFloat(document.getElementById('f-add-val').value) || 0; 
        document.getElementById('f-stock').value = (parseFloat(document.getElementById('f-stock').value) || 0) + val; 
        document.getElementById('f-add-val').value = ''; 
    }
    
    function isMedScheduledForDate(m, date) {
        return true; // Pro jednoduchost "Ka≈æd√Ω den"
    }

    function saveMed() {
        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('f-name').value;
        let timesVal = document.getElementById('f-times').value;

        if (!name || !timesVal) return alert("Vypl≈àte n√°zev a ƒçasy!");

        const data = { 
            id: id ? parseInt(id) : Date.now(), 
            name, 
            stock: parseFloat(document.getElementById('f-stock').value) || 0, 
            dose: parseFloat(document.getElementById('f-dose').value) || 1, 
            type: currentType, 
            times: timesVal.split(',').map(x => x.trim()).filter(x => x !== ""), 
            created: id ? meds.find(m => m.id == id).created : Date.now() 
        };

        if (id) { 
            const idx = meds.findIndex(m => m.id == id); 
            if(idx !== -1) meds[idx] = data; 
        } else { meds.push(data); }
        cancelEdit(); update();
    }

    function takeMed(id, time) {
        const m = meds.find(m => m.id === id);
        if (m) {
            m.stock = Math.round((m.stock - m.dose) * 100) / 100;
            history.push({ medId: id, date: new Date().toLocaleDateString('cs-CZ'), time });
            update();
        }
    }

    function editMed(id) {
        const m = meds.find(x => x.id == id);
        if(!m) return;
        cancelEdit();
        document.getElementById('form-title').innerText = "√öprava: " + m.name;
        document.getElementById('edit-id').value = m.id;
        document.getElementById('f-name').value = m.name;
        document.getElementById('f-stock').value = m.stock;
        document.getElementById('f-dose').value = m.dose;
        document.getElementById('f-times').value = m.times.join(', ');
        document.getElementById('stock-add-section').classList.remove('hidden');
        document.getElementById('cancel-btn').classList.remove('hidden');
        currentType = m.type;
        document.querySelectorAll('.type-chip').forEach(c => c.classList.toggle('chip-active', c.dataset.type === m.type));
        switchTab('list');
    }

    function deleteMed(id) { if(confirm("Smazat l√©k?")) { meds = meds.filter(m => m.id != id); update(); } }
    
    function cancelEdit() { 
        document.getElementById('form-title').innerText = "P≈ôidat nov√Ω l√©k"; 
        document.getElementById('edit-id').value = ''; 
        document.getElementById('f-name').value = ''; 
        document.getElementById('f-stock').value = ''; 
        document.getElementById('f-dose').value = '1'; 
        document.getElementById('f-times').value = ''; 
        document.getElementById('stock-add-section').classList.add('hidden'); 
        document.getElementById('cancel-btn').classList.add('hidden'); 
        document.querySelectorAll('.type-chip').forEach(c => c.classList.remove('chip-active')); 
        document.querySelector('[data-type="pill"]').classList.add('chip-active'); 
        currentType = 'pill'; 
    }

    function render() {
        const daily = document.getElementById('daily-list');
        const inv = document.getElementById('inventory-list');
        const timeShortcuts = document.getElementById('time-shortcuts');
        const todayStr = new Date().toLocaleDateString('cs-CZ');
        const now = new Date();
        
        daily.innerHTML = ''; inv.innerHTML = ''; timeShortcuts.innerHTML = '';
        document.getElementById('date-now').innerText = now.toLocaleDateString('cs-CZ', {weekday:'long', day:'numeric', month:'long'});
        
        let globalCrit = false;
        let schedule = [];

        meds.forEach(m => {
            let stockColor = 'var(--green)';
            if (m.stock < 10) { stockColor = 'var(--red)'; globalCrit = true; }
            else if (m.stock < 30) { stockColor = 'var(--accent)'; }

            inv.innerHTML += `
                <div class="flat-card p-4 flex flex-col gap-4" style="border-left-width: 6px; border-left-color: ${stockColor}">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-black text-lg uppercase text-accent leading-none mb-1">${m.name}</div>
                            <div class="text-[12px] font-bold" style="color: ${stockColor}">SKLADEM: ${m.stock} ks</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editMed(${m.id})" class="flat-btn px-3 py-1"><span class="iconify" data-icon="lucide:edit-3"></span></button>
                            <button onclick="deleteMed(${m.id})" class="flat-btn px-3 py-1 text-red-500"><span class="iconify" data-icon="lucide:trash-2"></span></button>
                        </div>
                    </div>
                </div>`;

            m.times.forEach(t => {
                schedule.push({ ...m, time: t, taken: history.some(h => h.medId === m.id && h.date === todayStr && h.time === t) });
            });
        });

        schedule.sort((a,b) => a.time.localeCompare(b.time)).forEach(item => {
            const iconMap = {pill:'lucide:pill', droplet:'lucide:droplets', syrup:'lucide:test-tube', syringe:'lucide:syringe'};
            daily.innerHTML += `
                <div class="flat-card p-4 flex items-center justify-between ${item.taken ? 'opacity-30 grayscale' : ''}">
                    <div class="flex items-center gap-4">
                        <div class="flat-input p-3 text-accent border-none"><span class="iconify text-3xl" data-icon="${iconMap[item.type] || 'lucide:pill'}"></span></div>
                        <div><div class="font-black text-xl leading-none mb-1">${item.name}</div><div class="text-base font-bold text-accent">${item.time} ‚Ä¢ ${item.dose} ks</div></div>
                    </div>
                    ${!item.taken ? `<button onclick="takeMed(${item.id},'${item.time}')" class="flat-btn btn-orange px-8 h-14 text-[16px] font-black uppercase">Vz√≠t</button>` : '<span class="iconify text-3xl text-green-500" data-icon="lucide:check-circle"></span>'}
                </div>`;
        });
        document.getElementById('global-critical-banner').classList.toggle('hidden', !globalCrit);
    }

    function switchTab(t) { 
        ['today', 'list', 'stats'].forEach(v => document.getElementById('view-' + v).classList.add('hidden')); 
        document.getElementById('view-' + t).classList.remove('hidden'); 
        ['today', 'list', 'stats'].forEach(b => document.getElementById('tab-' + b).classList.remove('btn-active')); 
        document.getElementById('tab-' + t).classList.add('btn-active'); 
    }

    // Interval pro kontrolu ƒçasu ka≈æd√Ωch 30 sekund
    setInterval(checkAndNotify, 30000);
    checkNotificationUI();
    render();
</script>
</body>
</html>
