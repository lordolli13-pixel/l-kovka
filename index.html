<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>L√©kovka PRO 2026</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --card-bg: #1e293b; --border: #334155; --accent: #f59e0b; --text-main: #f8fafc; }
        body { background-color: var(--bg); font-family: 'Quicksand', sans-serif; color: var(--text-main); min-height: 100vh; padding: 16px; }
        .flat-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; }
        .flat-input { background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: 10px; }
        .flat-btn { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-active { border-color: var(--accent); color: var(--accent); background: rgba(245, 158, 11, 0.1); }
        .btn-orange { background: var(--accent) !important; color: #0f172a !important; font-weight: 800; border: none; }
        .chip { padding: 10px; border-radius: 10px; font-size: 10px; font-weight: 800; cursor: pointer; background: rgba(255,255,255,0.05); text-align: center; border: 1px solid var(--border); }
        .chip-active { border-color: var(--accent); color: var(--accent); background: rgba(245, 158, 11, 0.1); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="max-w-2xl mx-auto pb-10">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-accent font-black tracking-tighter text-2xl uppercase">L√©kovka PRO</h1>
        <div id="date-now" class="text-[10px] font-bold opacity-50 uppercase text-right"></div>
    </div>

    <div class="flex gap-2 mb-4">
        <button onclick="switchTab('today')" id="tab-today" class="flat-btn flex-1 py-4 font-bold btn-active text-[10px] uppercase">Dnes</button>
        <button onclick="switchTab('list')" id="tab-list" class="flat-btn flex-1 py-4 font-bold text-[10px] uppercase">Z√°soby</button>
        <button onclick="switchTab('stats')" id="tab-stats" class="flat-btn flex-1 py-4 font-bold text-[10px] uppercase">Historie</button>
    </div>

    <div id="notif-bar" class="flex gap-2 mb-4">
        <button id="btn-notif-req" onclick="requestNotificationPermission()" class="flat-btn flex-1 py-2 text-[9px] font-black uppercase hidden">üîî Aktivovat upozornƒõn√≠</button>
        <button id="btn-notif-test" onclick="sendTestNotification()" class="flat-btn flex-1 py-2 text-[9px] font-black uppercase hidden border-accent/30 text-accent/60 italic">Zku≈°ebn√≠ notifikace</button>
    </div>

    <div id="view-today">
        <div id="critical-alert" class="hidden flat-card border-red-500 bg-red-500/10 p-4 mb-4 flex items-center gap-3 text-red-500 animate-pulse">
            <span class="iconify text-2xl" data-icon="lucide:alert-octagon"></span>
            <div class="text-[11px] font-black uppercase text-white">Doch√°zej√≠ z√°soby l√©k≈Ø!</div>
        </div>
        <div id="daily-list" class="space-y-3"></div>
    </div>

    <div id="view-list" class="hidden space-y-6">
        <div class="flat-card p-6">
            <h2 id="form-title" class="text-accent font-black text-xs uppercase mb-6 text-center tracking-widest">Nov√Ω l√©k</h2>
            <input type="hidden" id="edit-id">
            <div class="space-y-4">
                <div class="grid grid-cols-4 gap-2">
                    <div class="chip type-chip chip-active" onclick="setType(this, 'pill')" data-type="pill">Tbl.</div>
                    <div class="chip type-chip" onclick="setType(this, 'droplet')" data-type="droplet">Kapky</div>
                    <div class="chip type-chip" onclick="setType(this, 'syrup')" data-type="syrup">Sirup</div>
                    <div class="chip type-chip" onclick="setType(this, 'syringe')" data-type="syringe">Inj.</div>
                </div>
                <div class="flat-input p-3"><input id="f-name" class="w-full bg-transparent font-bold text-white outline-none text-sm" type="text" placeholder="N√°zev l√©ku..."></div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flat-input p-3"><label class="text-[8px] opacity-40 uppercase block mb-1">Z√°soba celkem</label><input id="f-stock" class="w-full bg-transparent font-bold text-white" type="number" step="0.25"></div>
                    <div class="flat-input p-3"><label class="text-[8px] opacity-40 uppercase block mb-1">D√°vka</label><input id="f-dose" class="w-full bg-transparent font-bold text-white" type="number" value="1" step="0.25"></div>
                </div>
                
                <div class="space-y-2">
                    <label class="text-[8px] opacity-40 uppercase block">ƒåasy u≈æ√≠v√°n√≠</label>
                    <div class="flex gap-2">
                        <input id="f-times" class="flat-input flex-1 p-3 bg-transparent font-bold text-white outline-none text-xs" type="text" readonly placeholder="Vyberte ƒçasy...">
                        <button onclick="document.getElementById('f-times').value=''" class="flat-btn px-4 text-red-500 text-[10px]">X</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="addTime('08:00')" class="flat-btn py-2 text-[9px]">08:00</button>
                        <button onclick="addTime('12:00')" class="flat-btn py-2 text-[9px]">12:00</button>
                        <button onclick="addTime('20:00')" class="flat-btn py-2 text-[9px]">20:00</button>
                    </div>
                    <div class="flex gap-2">
                        <input id="manual-time" type="time" class="flat-input flex-1 p-2 bg-transparent text-white font-bold outline-none">
                        <button onclick="addManualTime()" class="flat-btn px-4 py-2 text-[10px] font-black uppercase">+ P≈òIDAT ƒåAS</button>
                    </div>
                </div>

                <div class="space-y-2 pt-2">
                    <label class="text-[8px] opacity-40 uppercase block">Opakov√°n√≠</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-obden-sude" onclick="setObden('sude')" class="chip obden-chip">Sud√© dny</button>
                        <button id="btn-obden-liche" onclick="setObden('liche')" class="chip obden-chip">Lich√© dny</button>
                    </div>
                </div>

                <button onclick="saveMed()" class="flat-btn btn-orange w-full py-4 text-xs font-black uppercase tracking-widest mt-4">Ulo≈æit do datab√°ze</button>
                <button onclick="cancelEdit()" id="cancel-btn" class="hidden w-full text-[10px] opacity-50 uppercase py-2">Zru≈°it √∫pravy</button>
            </div>
        </div>
        <div id="inventory-list" class="space-y-3"></div>
    </div>

    <div id="view-stats" class="hidden space-y-4">
        <div class="flat-card p-6">
            <div id="calendar-header" class="flex justify-between items-center mb-6 font-black uppercase text-xs tracking-widest text-accent"></div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-[10px]"></div>
        </div>
        <div id="history-detail" class="flat-card p-4 space-y-2 text-[11px]"></div>
    </div>
</div>

<script>
    let meds = JSON.parse(localStorage.getItem('meds_v26')) || [];
    let history = JSON.parse(localStorage.getItem('hist_v26')) || [];
    let currentType = 'pill';
    let currentObden = null;
    let lastCheckedMinute = "";

    function update() { 
        localStorage.setItem('meds_v26', JSON.stringify(meds)); 
        localStorage.setItem('hist_v26', JSON.stringify(history)); 
        render(); 
    }

    // --- NOTIFIKACE ---
    function requestNotificationPermission() {
        Notification.requestPermission().then(permission => { if (permission === "granted") checkNotificationUI(); });
    }

    function checkNotificationUI() {
        const bReq = document.getElementById('btn-notif-req');
        const bTest = document.getElementById('btn-notif-test');
        if (Notification.permission === "granted") { bReq.classList.add('hidden'); bTest.classList.remove('hidden'); }
        else { bReq.classList.remove('hidden'); bTest.classList.add('hidden'); }
    }

    function triggerPush(title, body) {
        if (Notification.permission === "granted") {
            navigator.serviceWorker.ready.then(reg => {
                reg.showNotification(title, {
                    body,
                    icon: 'https://cdn-icons-png.flaticon.com/512/4320/4320353.png',
                    vibrate: [300, 100, 300],
                    tag: 'med-reminder'
                });
            });
        }
    }

    function sendTestNotification() { triggerPush("L√©kovka PRO", "Testovac√≠ notifikace funguje!"); }

    function checkAndNotify() {
        const now = new Date();
        const curTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        if (lastCheckedMinute === curTime) return;
        const todayStr = now.toLocaleDateString('cs-CZ');
        
        meds.forEach(m => {
            if (isScheduled(m, now)) {
                m.times.forEach(t => {
                    if (t === curTime) {
                        const taken = history.some(h => h.medId === m.id && h.date === todayStr && h.time === t);
                        if (!taken) triggerPush(`üíä ƒåas na l√©k: ${m.name}`, `D√°vka: ${m.dose} j.`);
                    }
                });
            }
        });
        lastCheckedMinute = curTime;
    }

    // --- LOGIKA ---
    function isScheduled(m, date) {
        if (m.obden === 'sude') return date.getDate() % 2 === 0;
        if (m.obden === 'liche') return date.getDate() % 2 !== 0;
        return true; 
    }

    function addTime(t) {
        let f = document.getElementById('f-times');
        let times = f.value ? f.value.split(',').map(x => x.trim()) : [];
        if (!times.includes(t)) { times.push(t); times.sort(); f.value = times.join(', '); }
    }

    function addManualTime() {
        const t = document.getElementById('manual-time').value;
        if (t) { addTime(t); document.getElementById('manual-time').value = ''; }
    }

    function setObden(val) {
        currentObden = (currentObden === val) ? null : val;
        document.querySelectorAll('.obden-chip').forEach(c => c.classList.remove('chip-active'));
        if (currentObden) document.getElementById('btn-obden-' + val).classList.add('chip-active');
    }

    function setType(el, type) {
        document.querySelectorAll('.type-chip').forEach(c => c.classList.remove('chip-active'));
        el.classList.add('chip-active');
        currentType = type;
    }

    function saveMed() {
        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('f-name').value;
        const timesVal = document.getElementById('f-times').value;
        if (!name || !timesVal) return alert("Vypl≈àte jm√©no a ƒçasy!");

        const data = {
            id: id ? parseInt(id) : Date.now(),
            name,
            stock: parseFloat(document.getElementById('f-stock').value) || 0,
            dose: parseFloat(document.getElementById('f-dose').value) || 1,
            type: currentType,
            obden: currentObden,
            times: timesVal.split(',').map(x => x.trim())
        };

        if (id) { const idx = meds.findIndex(m => m.id == id); meds[idx] = data; }
        else { meds.push(data); }
        cancelEdit(); update();
    }

    function editMed(id) {
        const m = meds.find(x => x.id == id);
        document.getElementById('edit-id').value = m.id;
        document.getElementById('f-name').value = m.name;
        document.getElementById('f-stock').value = m.stock;
        document.getElementById('f-dose').value = m.dose;
        document.getElementById('f-times').value = m.times.join(', ');
        setObden(m.obden);
        document.getElementById('cancel-btn').classList.remove('hidden');
        document.getElementById('form-title').innerText = "Upravit l√©k";
        switchTab('list');
    }

    function deleteMed(id) {
        if (confirm('Smazat l√©k?')) { meds = meds.filter(m => m.id !== id); update(); }
    }

    function takeMed(id, time) {
        const m = meds.find(m => m.id === id);
        m.stock = Math.max(0, Math.round((m.stock - m.dose) * 100) / 100);
        history.push({ medId: id, date: new Date().toLocaleDateString('cs-CZ'), time, timestamp: Date.now() });
        update();
    }

    function cancelEdit() {
        document.getElementById('edit-id').value = '';
        document.getElementById('f-name').value = '';
        document.getElementById('f-times').value = '';
        document.getElementById('cancel-btn').classList.add('hidden');
        document.getElementById('form-title').innerText = "Nov√Ω l√©k";
        currentObden = null;
        document.querySelectorAll('.obden-chip').forEach(c => c.classList.remove('chip-active'));
    }

    function render() {
        const dList = document.getElementById('daily-list');
        const iList = document.getElementById('inventory-list');
        const now = new Date();
        const todayStr = now.toLocaleDateString('cs-CZ');
        let crit = false;

        dList.innerHTML = ''; iList.innerHTML = '';
        document.getElementById('date-now').innerText = now.toLocaleDateString('cs-CZ', { weekday: 'long', day: 'numeric', month: 'long' });

        meds.forEach(m => {
            if (m.stock <= m.dose * 3) crit = true;
            if (isScheduled(m, now)) {
                m.times.forEach(t => {
                    const taken = history.some(h => h.medId === m.id && h.date === todayStr && h.time === t);
                    dList.innerHTML += `
                        <div class="flat-card p-4 flex justify-between items-center ${taken?'opacity-30':''}">
                            <div><div class="font-black text-sm uppercase">${m.name}</div><div class="text-[10px] text-accent font-bold">${t} ‚Ä¢ ${m.dose} j.</div></div>
                            ${!taken ? `<button onclick="takeMed(${m.id},'${t}')" class="flat-btn btn-orange px-6 py-2 text-[10px] font-black uppercase">VZ√çT</button>` : '<span class="text-green-500 font-bold">‚úì</span>'}
                        </div>`;
                });
            }
            iList.innerHTML += `
                <div class="flat-card p-4 flex justify-between items-center">
                    <div><div class="font-bold text-accent text-sm">${m.name}</div><div class="text-[10px] opacity-60 uppercase font-bold">Skladem: ${m.stock} j.</div></div>
                    <div class="flex gap-2">
                        <button onclick="editMed(${m.id})" class="flat-btn p-2 text-white/50"><span class="iconify" data-icon="lucide:edit-3"></span></button>
                        <button onclick="deleteMed(${m.id})" class="flat-btn p-2 text-red-500/50"><span class="iconify" data-icon="lucide:trash-2"></span></button>
                    </div>
                </div>`;
        });

        document.getElementById('critical-alert').className = crit ? 'flat-card border-red-500 bg-red-500/10 p-4 mb-4 flex items-center gap-3 text-red-500 animate-pulse' : 'hidden';
        checkNotificationUI();
    }

    function switchTab(t) {
        ['today', 'list', 'stats'].forEach(v => document.getElementById('view-' + v).classList.add('hidden'));
        ['today', 'list', 'stats'].forEach(b => document.getElementById('tab-' + b).classList.remove('btn-active'));
        document.getElementById('view-' + t).classList.remove('hidden');
        document.getElementById('tab-' + t).classList.add('btn-active');
        if (t === 'stats') renderStats();
    }

    function renderStats() {
        const grid = document.getElementById('calendar-grid');
        const header = document.getElementById('calendar-header');
        const now = new Date();
        header.innerText = now.toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' });
        grid.innerHTML = '';
        for (let i = 1; i <= 31; i++) {
            const dStr = `${i}. ${now.getMonth() + 1}. ${now.getFullYear()}`;
            const count = history.filter(h => h.date === dStr).length;
            grid.innerHTML += `<div class="p-2 flat-card ${count > 0 ? 'border-accent' : 'opacity-20'}">${i}</div>`;
        }
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); });
    }
    setInterval(checkAndNotify, 30000);
    render();
</script>
</body>
</html>
